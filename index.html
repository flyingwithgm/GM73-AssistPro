<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="GM73 Assist Pro - Offline emergency medical guidance">
    <meta name="theme-color" content="#0d47a1">
    <title>GM73 Assist Pro - First Response. Zero Delay.</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Advanced Glass, Neumorphic, Animated CSS --- */
        body {
            background: linear-gradient(135deg, #1565c0 0%, #43a047 100%);
            min-height: 100vh;
            color: #212121;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            transition: background 0.7s cubic-bezier(.75,.1,.15,1), color 0.3s;
        }
        [data-theme="dark"] body {
            background: linear-gradient(135deg, #212121 0%, #0d47a1 100%);
            color: #f5f5f5;
        }
        .container {
            max-width: 720px;
            margin: 40px auto;
            background: rgba(255,255,255,0.18);
            backdrop-filter: blur(18px);
            border-radius: 32px;
            box-shadow: 0 16px 40px rgba(31,38,135,0.22);
            padding: 36px;
            position: relative;
            animation: fadeIn 1s;
        }
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 42px;
        }
        .logo {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .logo i {
            color: #e53935;
            font-size: 2.6rem;
            filter: drop-shadow(0 0 8px #00bcd4);
            animation: pulse 2s infinite;
        }
        .logo h1 {
            font-size: 2rem;
            letter-spacing: 1px;
            color: #1565c0;
            font-weight: bold;
        }
        .tagline {
            font-size: 1rem;
            color: #e53935;
            font-weight: bold;
        }
        .theme-toggle, .language-toggle, .accessibility-toggle {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: inherit;
            cursor: pointer;
            margin-left: 18px;
        }
        .theme-toggle:focus, .language-toggle:focus, .accessibility-toggle:focus {
            outline: 2px solid #00bcd4;
            border-radius: 50%;
        }
        .emergency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(170px, 1fr));
            gap: 22px;
            margin-bottom: 30px;
        }
        .emergency-btn {
            background: linear-gradient(135deg, #1565c0 65%, #43a047 100%);
            color: white;
            border: none;
            border-radius: 22px;
            padding: 27px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            box-shadow: 0 8px 28px rgba(0,0,0,0.18);
            transition: transform 0.2s, box-shadow 0.2s, background 0.4s;
            position: relative;
            overflow: hidden;
        }
        .emergency-btn:focus {
            outline: 2px solid #e53935;
        }
        .emergency-btn:hover {
            background: linear-gradient(120deg, #43a047 60%, #1565c0 100%);
            transform: scale(1.04);
            box-shadow: 0 12px 40px rgba(0,0,0,0.18);
        }
        .emergency-btn i {
            font-size: 2.2rem;
            filter: drop-shadow(0 0 6px #00bcd4);
        }
        .emergency-btn span {
            font-size: 1.11rem;
            font-weight: 600;
            text-align: center;
        }
        .panic-btn {
            width: 100%;
            background: linear-gradient(90deg, #e53935 70%, #ff9800 100%);
            color: white;
            border: none;
            border-radius: 17px;
            padding: 21px;
            font-weight: bold;
            margin-bottom: 22px;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(255,0,0,0.13);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 16px;
            font-size: 1.2rem;
            animation: pulse 2s infinite;
        }
        .panic-btn:active {
            transform: scale(0.98);
            box-shadow: 0 6px 18px rgba(255,0,0,0.23);
        }
        .progress-container {
            width: 100%;
            background: rgba(0,0,0,0.12);
            border-radius: 8px;
            margin: 10px 0 18px 0;
            height: 15px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #43a047, #00bcd4);
            border-radius: 8px;
            width: 0%;
            transition: width 0.3s;
        }
        .guide-container {
            display: none;
            background: rgba(255,255,255,0.32);
            backdrop-filter: blur(13px);
            border-radius: 26px;
            padding: 32px;
            box-shadow: 0 8px 32px rgba(31,38,135,0.15);
            margin-bottom: 22px;
            animation: fadeIn 0.7s;
        }
        .guide-container.active {
            display: block;
        }
        .guide-title {
            color: #1565c0;
            margin-bottom: 10px;
            font-size: 1.27rem;
            font-weight: bold;
        }
        .guide-step {
            margin-bottom: 15px;
            padding-left: 18px;
            border-left: 4px solid #1565c0;
            font-size: 1.13rem;
            background: rgba(0,0,0,0.03);
            border-radius: 9px;
        }
        .guide-actions {
            display: flex;
            gap: 13px;
            margin-top: 24px;
        }
        .action-btn {
            flex: 1;
            padding: 13px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.07);
            transition: background 0.2s, color 0.2s, transform 0.2s;
        }
        .action-btn:focus {
            outline: 2px solid #00bcd4;
        }
        .yes-btn { background: #43a047; color: white; }
        .no-btn { background: #e53935; color: white; }
        .next-btn { background: #1565c0; color: white; }
        .back-btn { background: #ff9800; color: white; }
        .voice-toggle, .fab-btn, .accessibility-toggle {
            position: fixed;
            bottom: 22px;
            right: 22px;
            width: 57px; height: 57px;
            background: linear-gradient(135deg, #1565c0, #00bcd4);
            color: white;
            border: none;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 8px 24px rgba(0,0,0,0.14);
            z-index: 100;
            font-size: 1.6rem;
        }
        .fab-btn { bottom: 92px; right: 22px; background: linear-gradient(135deg, #e53935, #ff9800);}
        .fab-btn i { animation: pulse 2s infinite;}
        .accessibility-toggle { bottom: 22px; right: 92px; background: linear-gradient(135deg, #00bcd4, #43a047);}
        .pulse { animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.09); } 100% { transform: scale(1); } }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98);} to { opacity: 1; transform: scale(1);} }
        .modal {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            z-index: 9999;
            background: rgba(255,255,255,0.38);
            backdrop-filter: blur(15px);
            border-radius: 28px;
            box-shadow: 0 8px 32px rgba(31,38,135,0.22);
            padding: 32px 24px;
            min-width: 320px;
            min-height: 180px;
            display: none;
        }
        .modal.active { display: block; animation: fadeIn 0.5s;}
        .modal-header { font-size: 1.2rem; color: #1565c0; margin-bottom: 18px; font-weight: bold;}
        .modal-close {
            position: absolute;
            top: 18px; right: 22px;
            background: none; border: none;
            font-size: 1.2rem; color: #e53935;
            cursor: pointer;
        }
        .toast {
            position: fixed;
            top: 28px;
            right: 30px;
            background: linear-gradient(90deg, #43a047, #00bcd4);
            color: white;
            padding: 14px 30px;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.13);
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            animation: fadeIn 0.5s forwards;
        }
        .accessibility-panel {
            position: fixed;
            bottom: 80px;
            right: 92px;
            background: rgba(255,255,255,0.35);
            backdrop-filter: blur(10px);
            padding: 18px;
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(31,38,135,0.15);
            display: none;
            z-index: 9999;
        }
        .accessibility-panel.active { display: block; }
        .accessibility-panel label { display: block; margin: 10px 0 4px; }
        .accessibility-panel input[type="range"] { width: 100%; }
        .accessibility-panel button { margin-top: 10px; }
        html.access-large { font-size: 22px;}
        html.access-contrast { filter: contrast(1.3);}
        @media (max-width: 600px) {
            .container {margin: 0 0; border-radius: 0; padding: 10px;}
            .modal {min-width: 90vw;}
        }
        @media (max-width: 400px) {
            .emergency-grid { grid-template-columns: 1fr;}
            .emergency-btn { padding: 13px;}
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <i class="fas fa-first-aid"></i>
                <div>
                    <h1 id="mainTitle">GM73 Assist Pro</h1>
                    <p class="tagline">First Response. Zero Delay.</p>
                </div>
            </div>
            <div>
                <button class="theme-toggle" id="themeToggle" title="Toggle theme"><i class="fas fa-moon"></i></button>
                <button class="language-toggle" id="languageToggle" title="Change language"><i class="fas fa-globe"></i></button>
                <button class="accessibility-toggle" id="accessToggle" title="Accessibility options"><i class="fas fa-universal-access"></i></button>
            </div>
        </header>
        <button class="panic-btn pulse" id="panicBtn">
            <i class="fas fa-bell"></i> EMERGENCY PANIC MODE
        </button>
        <div class="emergency-grid">
            <button class="emergency-btn" data-emergency="unconscious">
                <i class="fas fa-procedures"></i>
                <span data-i18n="Unconscious Person">Unconscious Person</span>
            </button>
            <button class="emergency-btn" data-emergency="bleeding">
                <i class="fas fa-tint"></i>
                <span data-i18n="Severe Bleeding">Severe Bleeding</span>
            </button>
            <button class="emergency-btn" data-emergency="burn">
                <i class="fas fa-fire"></i>
                <span data-i18n="Burn Injury">Burn Injury</span>
            </button>
            <button class="emergency-btn" data-emergency="fracture">
                <i class="fas fa-bone"></i>
                <span data-i18n="Broken Bone">Broken Bone</span>
            </button>
            <button class="emergency-btn" data-emergency="choking">
                <i class="fas fa-lungs"></i>
                <span data-i18n="Choking">Choking</span>
            </button>
            <button class="emergency-btn" data-emergency="seizure">
                <i class="fas fa-brain"></i>
                <span data-i18n="Seizure">Seizure</span>
            </button>
            <button class="emergency-btn" data-emergency="allergy">
                <i class="fas fa-allergies"></i>
                <span data-i18n="Allergic Reaction">Allergic Reaction</span>
            </button>
            <button class="emergency-btn" data-emergency="notes">
                <i class="fas fa-notes-medical"></i>
                <span data-i18n="My Medical Notes">My Medical Notes</span>
            </button>
            <button class="emergency-btn" data-emergency="checklist">
                <i class="fas fa-kit-medical"></i>
                <span data-i18n="First Aid Kit">First Aid Kit</span>
            </button>
            <button class="emergency-btn" data-emergency="log">
                <i class="fas fa-clipboard-list"></i>
                <span data-i18n="Incident Log">Incident Log</span>
            </button>
            <button class="emergency-btn" data-emergency="reminders">
                <i class="fas fa-pills"></i>
                <span data-i18n="Reminders">Reminders</span>
            </button>
        </div>
        <div class="guide-container" id="guideContainer">
            <div class="progress-container">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <h2 class="guide-title" id="guideTitle"></h2>
            <div id="guideContent"></div>
            <div class="guide-actions" id="guideActions"></div>
        </div>
    </div>
    <!-- Floating Buttons -->
    <button class="voice-toggle" id="voiceToggle" title="Toggle voice">
        <i class="fas fa-volume-up"></i>
    </button>
    <button class="fab-btn" id="fabWidget" title="Quick Panic/Call">
        <i class="fas fa-phone-volume"></i>
    </button>
    <!-- Accessibility Panel -->
    <div class="accessibility-panel" id="accessPanel">
        <label for="fontSize">Font Size</label>
        <input type="range" id="fontSize" min="16" max="28" value="18">
        <label>
            <input type="checkbox" id="contrastToggle"> High Contrast
        </label>
        <button id="closeAccessPanel">Close</button>
    </div>
    <!-- Modals -->
    <div class="modal" id="modalChecklist">
        <button class="modal-close" onclick="closeModal('modalChecklist')"><i class="fas fa-times"></i></button>
        <div class="modal-header">First Aid Kit Checklist</div>
        <div id="modalChecklistContent"></div>
    </div>
    <div class="modal" id="modalLog">
        <button class="modal-close" onclick="closeModal('modalLog')"><i class="fas fa-times"></i></button>
        <div class="modal-header">Incident Log</div>
        <div id="modalLogContent"></div>
    </div>
    <div class="modal" id="modalReminders">
        <button class="modal-close" onclick="closeModal('modalReminders')"><i class="fas fa-times"></i></button>
        <div class="modal-header">Medication/Allergy Reminders</div>
        <div id="modalRemindersContent"></div>
    </div>
    <div class="toast" id="toast"></div>
    <script>
    // --- JS Logic ---
    const config = {
        voiceEnabled: false,
        currentTheme: 'light',
        currentLanguage: 'en',
        currentEmergency: null,
        currentStep: 0,
        decisionPath: [],
        incidentLog: [],
        reminders: [],
        firstAidKit: [
            {item: "Bandages", have: false},
            {item: "Antiseptic wipes", have: false},
            {item: "Adhesive tape", have: false},
            {item: "Scissors", have: false},
            {item: "Gloves", have: false},
            {item: "Painkillers", have: false},
            {item: "CPR mask", have: false},
            {item: "Tweezers", have: false}
        ]
    };
    // Emergency Decision Trees
    const emergencyData = {
        unconscious: {
            title: "Unconscious Person",
            steps: [
                {
                    text: "Is the person breathing normally?",
                    type: "question",
                    yes: 1,
                    no: 2
                },
                {
                    text: "Place the person in the recovery position:\n1. Kneel beside them\n2. Place arm nearest to you at right angle\n3. Bring other hand to cheek\n4. Bend far knee and roll them towards you\n5. Tilt head back to keep airway open.",
                    type: "instruction"
                },
                {
                    text: "Begin CPR:\n1. Call for help\n2. Place heel of hand on breastbone\n3. Push hard and fast (100-120 compressions per minute)\n4. If trained, give 2 rescue breaths after 30 compressions\n5. Continue until help arrives.",
                    type: "instruction"
                }
            ]
        },
        bleeding: {
            title: "Severe Bleeding",
            steps: [
                {
                    text: "Is the bleeding from a major artery (bright red, spurting blood)?",
                    type: "question",
                    yes: 1,
                    no: 2
                },
                {
                    text: "Apply direct pressure with clean cloth.\nIf bleeding continues, apply pressure to artery above wound.\nUse tourniquet ONLY as last resort.\nKeep victim lying down.",
                    type: "instruction"
                },
                {
                    text: "Clean wound with clean water if available.\nApply direct pressure with clean cloth.\nBandage firmly.\nWatch for signs of infection.",
                    type: "instruction"
                }
            ]
        },
        burn: {
            title: "Burn Injury",
            steps: [
                {
                    text: "Is this a chemical burn?",
                    type: "question",
                    yes: 1,
                    no: 2
                },
                {
                    text: "Remove contaminated clothing.\nRinse with cool running water for 20+ minutes.\nDo not neutralize chemicals.\nCover loosely with clean cloth.",
                    type: "instruction"
                },
                {
                    text: "Cool with running water for 10-15 minutes.\nDo not use ice.\nRemove tight items before swelling.\nCover with sterile dressing.\nDo not break blisters.",
                    type: "instruction"
                }
            ]
        },
        fracture: {
            title: "Broken Bone",
            steps: [
                {
                    text: "Is the broken bone visible through the skin?",
                    type: "question",
                    yes: 1,
                    no: 2
                },
                {
                    text: "Do NOT push bone back in.\nCover with sterile dressing.\nImmobilize limb with splints or padding.\nSeek medical help immediately.",
                    type: "instruction"
                },
                {
                    text: "Immobilize the limb with splints or padding.\nApply ice to reduce swelling.\nElevate if possible.\nSeek medical help.",
                    type: "instruction"
                }
            ]
        },
        choking: {
            title: "Choking",
            steps: [
                {
                    text: "Is the person able to cough or speak?",
                    type: "question",
                    yes: 1,
                    no: 2
                },
                {
                    text: "Encourage them to keep coughing. Do not interfere unless they stop coughing or become unconscious.",
                    type: "instruction"
                },
                {
                    text: "Perform Heimlich maneuver:\n1. Stand behind person\n2. Make fist above navel\n3. Grasp fist with other hand\n4. Give quick upward thrusts\n5. Continue until object is expelled or help arrives.",
                    type: "instruction"
                }
            ]
        },
        seizure: {
            title: "Seizure",
            steps: [
                {
                    text: "Is the person in immediate danger (e.g., near water, on stairs)?",
                    type: "question",
                    yes: 1,
                    no: 2
                },
                {
                    text: "Move them to a safe area if possible. Do NOT restrain.",
                    type: "instruction"
                },
                {
                    text: "Clear area around person.\nPlace something soft under their head.\nDo NOT restrain or put anything in their mouth.\nCall for medical help if seizure lasts more than 5 minutes.",
                    type: "instruction"
                }
            ]
        },
        allergy: {
            title: "Allergic Reaction",
            steps: [
                {
                    text: "Is there difficulty breathing or swelling of face/tongue?",
                    type: "question",
                    yes: 1,
                    no: 2
                },
                {
                    text: "Inject epinephrine (EpiPen) if available.\nCall emergency services.\nMonitor breathing until help arrives.",
                    type: "instruction"
                },
                {
                    text: "Remove allergen if possible.\nGive antihistamine if not contraindicated.\nObserve for worsening symptoms.",
                    type: "instruction"
                }
            ]
        },
        notes: {
            title: "My Medical Notes",
            steps: [
                {
                    text: "Your personal medical information (stored only on this device):",
                    type: "notes"
                }
            ]
        }
    };
    const i18n = {
        en: {
            "Unconscious Person": "Unconscious Person",
            "Severe Bleeding": "Severe Bleeding",
            "Burn Injury": "Burn Injury",
            "Broken Bone": "Broken Bone",
            "Choking": "Choking",
            "Seizure": "Seizure",
            "Allergic Reaction": "Allergic Reaction",
            "My Medical Notes": "My Medical Notes",
            "First Aid Kit": "First Aid Kit",
            "Incident Log": "Incident Log",
            "Reminders": "Reminders"
        },
        es: {
            "Unconscious Person": "Persona Inconsciente",
            "Severe Bleeding": "Sangrado Grave",
            "Burn Injury": "Quemadura",
            "Broken Bone": "Fractura",
            "Choking": "Atragantamiento",
            "Seizure": "Convulsión",
            "Allergic Reaction": "Reacción Alérgica",
            "My Medical Notes": "Mis Datos Médicos",
            "First Aid Kit": "Botiquín",
            "Incident Log": "Registro de Incidentes",
            "Reminders": "Recordatorios"
        }
    };
    // DOM Elements
    const themeToggle = document.getElementById('themeToggle');
    const voiceToggle = document.getElementById('voiceToggle');
    const panicBtn = document.getElementById('panicBtn');
    const emergencyBtns = document.querySelectorAll('.emergency-btn');
    const guideContainer = document.getElementById('guideContainer');
    const guideTitle = document.getElementById('guideTitle');
    const guideContent = document.getElementById('guideContent');
    const guideActions = document.getElementById('guideActions');
    const progressBar = document.getElementById('progressBar');
    const languageToggle = document.getElementById('languageToggle');
    const fabWidget = document.getElementById('fabWidget');
    const accessToggle = document.getElementById('accessToggle');
    const accessPanel = document.getElementById('accessPanel');
    const fontSize = document.getElementById('fontSize');
    const contrastToggle = document.getElementById('contrastToggle');
    const closeAccessPanel = document.getElementById('closeAccessPanel');
    const toast = document.getElementById('toast');

    // Modals
    function openModal(id) { document.getElementById(id).classList.add('active'); }
    function closeModal(id) { document.getElementById(id).classList.remove('active'); }

    // Accessibility
    accessToggle.addEventListener('click', ()=>{ accessPanel.classList.toggle('active'); });
    fontSize.addEventListener('input', ()=>{ document.documentElement.style.fontSize = fontSize.value+'px'; });
    contrastToggle.addEventListener('change', ()=>{ document.documentElement.classList.toggle('access-contrast', contrastToggle.checked); });
    closeAccessPanel.addEventListener('click', ()=>{ accessPanel.classList.remove('active'); });

    // Widget/FAB
    fabWidget.addEventListener('click', ()=>{ startEmergency('unconscious'); showToast('Quick emergency guide activated!'); });

    // Language
    languageToggle.addEventListener('click', ()=>{
        config.currentLanguage = (config.currentLanguage === 'en') ? 'es' : 'en';
        updateLanguage();
        showToast('Language switched');
    });
    function updateLanguage() {
        document.querySelectorAll('[data-i18n]').forEach(el=>{
            const key = el.getAttribute('data-i18n');
            el.textContent = i18n[config.currentLanguage][key] || key;
        });
        document.getElementById('mainTitle').textContent = "GM73 Assist Pro";
    }
    function setTheme(theme) {
        config.currentTheme = theme;
        document.documentElement.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        themeToggle.innerHTML = `<i class="fas ${theme === 'dark' ? 'fa-sun' : 'fa-moon'}"></i>`;
    }
    function toggleTheme() {
        setTheme(config.currentTheme === 'light' ? 'dark' : 'light');
    }
    themeToggle.addEventListener('click', toggleTheme);
    function autoDarkMode() {
        const hour = new Date().getHours();
        if (hour > 19 || hour < 7) setTheme('dark');
        else setTheme('light');
    }
    autoDarkMode();
    function updateVoiceToggle() {
        voiceToggle.innerHTML = `<i class="fas ${config.voiceEnabled ? 'fa-volume-up' : 'fa-volume-mute'}"></i>`;
    }
    function toggleVoice() {
        config.voiceEnabled = !config.voiceEnabled;
        localStorage.setItem('voiceEnabled', config.voiceEnabled);
        updateVoiceToggle();
        if (config.voiceEnabled && guideContainer.classList.contains('active')) speakCurrentStep();
    }
    voiceToggle.addEventListener('click', toggleVoice);

    function speak(text) {
        if (!config.voiceEnabled) return;
        if ('speechSynthesis' in window) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.92;
            speechSynthesis.speak(utterance);
        }
    }
    function speakCurrentStep() {
        const text = guideTitle.textContent + '. ' + guideContent.textContent;
        speak(text);
    }
    function startEmergency(emergencyType) {
        config.currentEmergency = emergencyType;
        config.currentStep = 0;
        config.decisionPath = [0];
        guideContainer.classList.add('active');
        renderStep();
    }
    function renderStep() {
        if(config.currentEmergency==="checklist") { openChecklist(); return; }
        if(config.currentEmergency==="log") { openLog(); return; }
        if(config.currentEmergency==="reminders") { openReminders(); return; }
        if(config.currentEmergency==="notes") { renderMedicalNotes(); return; }
        const emergency = emergencyData[config.currentEmergency];
        if(!emergency) return;
        let step = emergency.steps[config.decisionPath[config.decisionPath.length - 1]];
        guideTitle.textContent = emergency.title;
        const progress = Math.min(100, ((config.decisionPath.length) / emergency.steps.length) * 100);
        progressBar.style.width = `${progress}%`;
        guideContent.innerHTML = '';
        guideActions.innerHTML = '';
        switch (step.type) {
            case 'question':
                guideContent.innerHTML = `<p class="guide-step">${step.text}</p>`;
                const yesBtn = document.createElement('button');
                yesBtn.className = 'action-btn yes-btn';
                yesBtn.textContent = 'Yes';
                yesBtn.onclick = () => answerQuestion(step.yes);
                const noBtn = document.createElement('button');
                noBtn.className = 'action-btn no-btn';
                noBtn.textContent = 'No';
                noBtn.onclick = () => answerQuestion(step.no);
                guideActions.appendChild(yesBtn);
                guideActions.appendChild(noBtn);
                break;
            case 'instruction':
                const instructions = step.text.split('\n').map(inst => `<p class="guide-step">${inst}</p>`).join('');
                guideContent.innerHTML = instructions;
                const backBtn = document.createElement('button');
                backBtn.className = 'action-btn back-btn';
                backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Back';
                backBtn.onclick = goBack;
                const nextBtn = document.createElement('button');
                nextBtn.className = 'action-btn next-btn';
                nextBtn.innerHTML = 'Done <i class="fas fa-check"></i>';
                nextBtn.onclick = closeGuide;
                guideActions.appendChild(backBtn);
                guideActions.appendChild(nextBtn);
                break;
            case 'notes':
                renderMedicalNotes();
                break;
            default:
                guideContent.innerHTML = `<p class="guide-step">${step.text}</p>`;
                guideActions.innerHTML = `<button class="action-btn next-btn" onclick="closeGuide()">Done <i class="fas fa-check"></i></button>`;
                break;
        }
        if (config.voiceEnabled) speakCurrentStep();
    }
    function answerQuestion(nextStep) {
        config.decisionPath.push(nextStep);
        config.currentStep = nextStep;
        renderStep();
    }
    function goBack() {
        if (config.decisionPath.length > 1) {
            config.decisionPath.pop();
            config.currentStep = config.decisionPath[config.decisionPath.length - 1];
            renderStep();
        } else {
            closeGuide();
        }
    }
    function closeGuide() {
        guideContainer.classList.remove('active');
        speechSynthesis.cancel();
    }
    function renderMedicalNotes() {
        const notes = JSON.parse(localStorage.getItem('medicalNotes') || JSON.stringify({
            bloodType: '',
            allergies: '',
            medications: '',
            conditions: '',
            emergencyContact: ''
        }));
        let html = `
            <div class="notes-form">
                <div class="form-group">
                    <label>Blood Type:</label>
                    <input type="text" id="bloodType" value="${notes.bloodType}" placeholder="e.g., O+">
                </div>
                <div class="form-group">
                    <label>Allergies:</label>
                    <textarea id="allergies" placeholder="List any allergies">${notes.allergies}</textarea>
                </div>
                <div class="form-group">
                    <label>Current Medications:</label>
                    <textarea id="medications" placeholder="List current medications">${notes.medications}</textarea>
                </div>
                <div class="form-group">
                    <label>Medical Conditions:</label>
                    <textarea id="conditions" placeholder="List any medical conditions">${notes.conditions}</textarea>
                </div>
                <div class="form-group">
                    <label>Emergency Contact:</label>
                    <input type="text" id="emergencyContact" value="${notes.emergencyContact}" placeholder="Name and phone number">
                </div>
            </div>
        `;
        guideTitle.textContent = emergencyData.notes.title;
        guideContent.innerHTML = html;
        guideActions.innerHTML = '';
        const saveBtn = document.createElement('button');
        saveBtn.className = 'action-btn next-btn';
        saveBtn.textContent = 'Save Information';
        saveBtn.onclick = saveMedicalNotes;
        guideActions.appendChild(saveBtn);
    }
    function saveMedicalNotes() {
        const notes = {
            bloodType: document.getElementById('bloodType').value,
            allergies: document.getElementById('allergies').value,
            medications: document.getElementById('medications').value,
            conditions: document.getElementById('conditions').value,
            emergencyContact: document.getElementById('emergencyContact').value
        };
        localStorage.setItem('medicalNotes', JSON.stringify(notes));
        guideContent.innerHTML = '<p class="guide-step" style="color: #43a047">Your medical information has been saved securely on this device.</p>';
        guideActions.innerHTML = '';
        const backBtn = document.createElement('button');
        backBtn.className = 'action-btn back-btn';
        backBtn.innerHTML = '<i class="fas fa-arrow-left"></i> Back';
        backBtn.onclick = renderMedicalNotes;
        const doneBtn = document.createElement('button');
        doneBtn.className = 'action-btn next-btn';
        doneBtn.innerHTML = 'Done <i class="fas fa-check"></i>';
        doneBtn.onclick = closeGuide;
        guideActions.appendChild(backBtn);
        guideActions.appendChild(doneBtn);
    }
    function openChecklist() {
        openModal('modalChecklist');
        const cont = document.getElementById('modalChecklistContent');
        cont.innerHTML = config.firstAidKit.map((item,i)=>
            `<label>
                <input type="checkbox" ${item.have?'checked':''} onchange="toggleKitItem(${i})">
                ${item.item}
            </label>`
        ).join('');
    }
    window.toggleKitItem = function(idx) {
        config.firstAidKit[idx].have = !config.firstAidKit[idx].have;
        showToast(config.firstAidKit[idx].item + (config.firstAidKit[idx].have ? " checked!" : " unchecked!"));
    }
    function openLog() {
        openModal('modalLog');
        const cont = document.getElementById('modalLogContent');
        cont.innerHTML = `
            <button onclick="logIncident()">Log New Incident</button>
            <ul>${config.incidentLog.map(inc=>`<li>${inc.date}: ${inc.type}</li>`).join('')}</ul>
        `;
    }
    window.logIncident = function() {
        const type = prompt("Incident type?");
        const note = prompt("Notes?");
        config.incidentLog.push({date: new Date().toLocaleString(), type, note});
        openLog();
        showToast("Incident logged!");
    }
    function openReminders() {
        openModal('modalReminders');
        const cont = document.getElementById('modalRemindersContent');
        cont.innerHTML = `
            <button onclick="addReminder()">Add Reminder</button>
            <ul>${config.reminders.map(rem=>`<li>${rem.time}: ${rem.text}</li>`).join('')}</ul>
        `;
    }
    window.addReminder = function() {
        const text = prompt("Reminder text?");
        const time = prompt("Time?");
        config.reminders.push({text, time});
        openReminders();
        showToast("Reminder added!");
    }
    function showToast(msg) {
        toast.textContent = msg;
        toast.style.opacity = 1;
        setTimeout(()=>{ toast.style.opacity = 0; }, 2200);
    }
    emergencyBtns.forEach(btn=>{
        btn.addEventListener('click', function(){
            const emergencyType = this.getAttribute('data-emergency');
            startEmergency(emergencyType);
        });
    });
    panicBtn.addEventListener('click', ()=>{ startEmergency('unconscious'); showToast('Panic Mode Activated'); });
    document.addEventListener('DOMContentLoaded', ()=>{
        setTheme(localStorage.getItem('theme')||'light');
        config.voiceEnabled = localStorage.getItem('voiceEnabled')==='true';
        updateVoiceToggle();
        updateLanguage();
    });
    document.addEventListener('keydown', function(e){
        if(e.key==='Escape') {
            document.querySelectorAll('.modal.active').forEach(m=>m.classList.remove('active'));
            guideContainer.classList.remove('active');
        }
    });
    </script>
</body>
</html>
